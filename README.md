# Cloud SIEM AWS Threat Emulation Guide

## Table of Contents
- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Emulating Attacks](#emulating-attacks)
- [Validating Detections](#validating-detections)


## Introduction
The Cloud SIEM AWS Threat Emulation Guide is designed to simplify the process of evaluating Datadog's Cloud SIEM security capabilities to detect AWS threats and alert in real time by simulating attacks using [Stratus Red Team](https://github.com/DataDog/stratus-red-team).

## Prerequisites
- A functional Datadog trial or production environment with:
    - [Cloud SIEM enabled](https://docs.datadoghq.com/getting_started/cloud_siem/)
    - [AWS CloudTrail logging](https://docs.datadoghq.com/security/cloud_siem/guide/aws-config-guide-for-cloud-siem/)
- AWS Sandbox account - Stratus Red Team is supposed to be used against a sandbox cloud account that does not handle production workloads or infrastructure.
- Prior AWS authentication via cli using either `aws-vault` or static credentials in `~/.aws/config` with `AdministratorAccess`
- An endpoint for installing Stratus Red Team and executing attack techniques against AWS infrastructure.
    - Stratus [supports](https://stratus-red-team.cloud/user-guide/getting-started/) MacOS, Linux, Windows & Docker.

***Although Stratus Red Team supports attacks for other platforms including Azure, Google Cloud and Kubernetes, this guide is currenty limited to AWS.***

## Installation
To install Stratus Red Team within your threat emulation environment, follow any of the following steps:

- Mac OS:

```
brew tap datadog/stratus-red-team https://github.com/DataDog/stratus-red-team
brew install datadog/stratus-red-team/stratus-red-team
```

- Linux / Windows / Mac OS: Download one of the [pre-built binaries](https://github.com/datadog/stratus-red-team/releases).

- Docker:

```bash
IMAGE="ghcr.io/datadog/stratus-red-team"
alias stratus="docker run --rm -v $HOME/.stratus-red-team/:/root/.stratus-red-team/ -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_SESSION_TOKEN -e AWS_DEFAULT_REGION $IMAGE"
```

## Emulating Attacks

### Run all attacks
Utilizing the **stratus.sh** script you can detonate all available stratus attacks in one go.

### Run individual attacks

Alternatively, you can detonate the stratus attacks individually as shown below.

- Detonate an attack technique:
```
stratus detonate aws.exfiltration.s3-backdoor-bucket-policy
```

- Detonate multiple attack techniques:
```
stratus detonate aws.exfiltration.s3-backdoor-bucket-policy aws.defense-evasion.cloudtrail-stop
```

- Detonate an attack technique, then automatically clean up any resources deployed on AWS
```
stratus detonate aws.exfiltration.s3-backdoor-bucket-policy --cleanup
```

For more details on usage, refer to the [Stratus Red Team Usage Guide](https://stratus-red-team.cloud/user-guide/usage/) and [Stratus Red Team Command Reference](https://stratus-red-team.cloud/user-guide/commands/)

## Validating Detections
***Note that Datadog's OOTB Cloud SIEM Rules are **not** limited to the attack techniques available from Stratus Red Team.***

Within the Datadog app, navigate to **Security** > **Cloud SIEM** > **Signals** and filter by `source:cloudtrail @userIdentity.accessKeyId:<access key id of authenticated cli user>` in order to validate the signals generated by the emulation.

You should expect the following the detections for the detonated Stratus Techniques:

| **Stratus Technique**                                  	| **Cloud SIEM OOTB Detection**                                                                                                                                                                                                                                      	|
|--------------------------------------------------------	|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|
| Retrieve EC2 Password Data                             	| Encrypted administrator password retrieved for Windows EC2 instance                                                                                                                                                                                                	|
| Steal EC2 Instance Credentials                         	| AWS GuardDuty finding - Credentials for instance role stratus-red-team-ec2-steal-credentials-role used from external IP address.                                                                                                                                   	|
| Retrieve a High Number of Secrets Manager secrets      	| [WIP] AWS Secrets Manager secret retrieved by previously unseen user<br>[WIP] Anomalous amount of secrets retrieved from AWS Secrets Manager                                                                                                                       	|
| Retrieve And Decrypt SSM Parameters                    	| [WIP] AWS Systems Manager decrypted secure string retrieved<br>[WIP] AWS Systems Manager parameters retrieved by previously unseen user                                                                                                                            	|
| Delete CloudTrail Trail                                	| AWS CloudTrail configuration modified                                                                                                                                                                                                                              	|
| Disable CloudTrail Logging Through Event Selectors     	| AWS Disable Cloudtrail with event selectors                                                                                                                                                                                                                        	|
| CloudTrail Logs Impairment Through S3 Lifecycle Rule   	| An AWS S3 bucket lifecycle policy expiration is set to < 90 days                                                                                                                                                                                                   	|
| Stop CloudTrail Trail                                  	| AWS CloudTrail configuration modified                                                                                                                                                                                                                              	|
| Attempt to Leave the AWS Organization                  	| An AWS account attempted to leave the AWS Organization                                                                                                                                                                                                             	|
| Remove VPC Flow Logs                                   	| [WIP] AWS VPC Flow Log deleted                                                                                                                                                                                                                                     	|
| Download EC2 Instance User Data                        	| [WIP] Amazon EC2 Instance user data enumeration attempt by never before seen identity                                                                                                                                                                              	|
| Execute Discovery Commands on an EC2 Instance          	| An EC2 instance attempted to enumerate S3 bucket<br>[WIP] AWS enumeration activity from EC2 instance<br>[WIP] AWS Cloudtrail GetCallerIdentity followed by discovery API calls accessed denied<br>[WIP] AWS Cloudtrail GetCallerIdentity followed by IAM API calls 	|
| Launch Unusual EC2 instances                           	| [Stratus Fix] The image id '[ami-07236aa4769c3a10d]' does not exist                                                                                                                                                                                                	|
| Execute Commands on EC2 Instance via User Data         	| Possible AWS EC2 privilege escalation via the modification of user data                                                                                                                                                                                            	|
| Open Ingress Port 22 on a Security Group               	| AWS security group created, modified or deleted<br>Potential administrative port open to the world via AWS security group                                                                                                                                          	|
| Exfiltrate an AMI by Sharing It                        	| [WIP] Amazon EC2 AMI exfiltration attempt                                                                                                                                                                                                                          	|
| Exfiltrate EBS Snapshot by Sharing It                  	| AWS EBS Snapshot possible exfiltration                                                                                                                                                                                                                             	|
| Exfiltrate RDS Snapshot by Sharing                     	| Possible RDS Snapshot Exfiltration                                                                                                                                                                                                                                 	|
| Backdoor an S3 Bucket via its Bucket Policy            	| Amazon S3 Bucket policy modified                                                                                                                                                                                                                                   	|
| Console Login without MFA                              	| AWS Console login without MFA                                                                                                                                                                                                                                      	|
| Backdoor an IAM Role                                   	| AWS IAM AdministratorAccess policy was applied to a role<br>[WIP] AWS IAM policy changed                                                                                                                                                                           	|
| Create an Access Key on an IAM User                    	| [WIP] AWS access key creation observed from new IAM user                                                                                                                                                                                                           	|
| Create an administrative IAM User                      	| AWS IAM AdministratorAccess policy was applied to a user                                                                                                                                                                                                           	|
| Create a Login Profile on an IAM User                  	| [WIP] AWS IAM user login profile created or updated                                                                                                                                                                                                                	|
| Backdoor Lambda Function Through Resource-Based Policy 	| [Stratus Fix] nodejs12.x is no longer supported for creating/updating Lambda functions. AWS recommends (nodejs18.x).                                                                                                                                               	|
| Overwrite Lambda Function Code                         	| [WIP] AWS Lambda function modified by IAM user                                                                                                                                                                                                                     	|
| Create an IAM Roles Anywhere trust anchor              	| [WIP] AWS IAM Roles Anywhere trust anchor created                                                                                                                                                                                                                  	|
